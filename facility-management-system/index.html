<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Quản lý Cơ sở vật chất</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="styles/main.css" rel="stylesheet">
  <link href="styles/dashboard.css" rel="stylesheet">
  <link href="styles/responsive.css" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <div class="container-fluid bg-white shadow-sm py-2 mb-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="brand">
        <i class="fa-solid fa-school fa-2x text-primary"></i>
        <div>
          <h4 class="mb-0">THCS Hàn Thuyên</h4>
        </div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <div id="sync-indicator" class="me-2"><span class="badge bg-secondary">Local</span></div>
        <div id="current-user"></div>
        <button id="btn-open-login" class="btn btn-outline-primary btn-sm">Đăng nhập</button>
        <button id="btn-open-signup" class="btn btn-outline-success btn-sm">Đăng ký</button>
        <button id="btn-users-mgmt" class="btn btn-outline-info btn-sm" style="display:none">Người dùng</button>
        <button id="btn-logout" class="btn btn-outline-danger btn-sm" style="display:none">Đăng xuất</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container-app">
    <section class="hero mb-4 card-soft">
      <div style="flex:1">
        <h2 class="mb-1">Hệ thống Quản lý Cơ sở vật chất</h2>
        <div class="top-controls d-flex gap-2">
          <button id="btn-add-room" class="btn btn-primary"><i class="fa-solid fa-door-open me-2"></i>Thêm phòng</button>
          <button id="btn-add-asset" class="btn btn-outline-primary"><i class="fa-solid fa-box me-2"></i>Thêm thiết bị / vật tư</button>
          <button id="btn-add-req" class="btn btn-outline-warning"><i class="fa-solid fa-wrench me-2"></i>Tạo yêu cầu</button>
          <div class="ms-auto btn-group">
            <button id="btn-export-excel" class="btn btn-success"><i class="fa-solid fa-file-excel me-1"></i>Xuất Excel</button>
            <button id="btn-clear-data" class="btn btn-outline-danger" title="Xoá toàn bộ data (demo)"><i class="fa-solid fa-trash"></i></button>
          </div>
        </div>
      </div>
      <img src="assets/images/banner.jpg" alt="Banner">
    </section>

    <!-- Stats -->
    <div id="stats-area" class="row g-3 mb-4">
      <div class="col-md-4"><div class="card-soft h-100"><small class="small-muted">Tổng phòng</small><h3 id="stat-rooms">0</h3></div></div>
      <div class="col-md-4"><div class="card-soft h-100"><small class="small-muted">Tổng tài sản</small><h3 id="stat-assets">0</h3></div></div>
      <div class="col-md-4"><div class="card-soft h-100"><small class="small-muted">Yêu cầu đang mở</small><h3 id="stat-requests">0</h3></div></div>
    </div>

    <!-- Main Content Area -->
    <div class="row g-3">
      <div class="col-lg-7">
        <div class="card-soft">
          <ul class="nav nav-tabs mb-3" id="mainTabs">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-rooms">Phòng</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-assets">Tài sản</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-inv">Kho (Vật tư)</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-reqs">Yêu cầu</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-logs">Lịch sử</a></li>
          </ul>

          <div class="tab-content">
            <!-- Rooms -->
            <div class="tab-pane fade show active" id="tab-rooms">
              <div class="d-flex mb-2 gap-2">
                <input id="search-rooms" class="form-control form-control-sm" placeholder="Tìm phòng...">
                <button id="btn-refresh-rooms" class="btn btn-sm btn-outline-secondary">Làm mới</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover" id="tbl-rooms">
                  <thead>
                    <tr>
                      <th data-col="id">Mã <i class="fa-solid fa-filter col-filter-icon" data-table="rooms" data-col="id" title="Lọc cột"></i></th>
                      <th data-col="name">Tên <i class="fa-solid fa-filter col-filter-icon" data-table="rooms" data-col="name"></i></th>
                      <th data-col="capacity">Sức chứa <i class="fa-solid fa-filter col-filter-icon" data-table="rooms" data-col="capacity"></i></th>
                      <th data-col="notes">Ghi chú <i class="fa-solid fa-filter col-filter-icon" data-table="rooms" data-col="notes"></i></th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="rooms-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Assets -->
            <div class="tab-pane fade" id="tab-assets">
              <div class="d-flex mb-2 gap-2">
                <select id="filter-asset-status" class="form-select form-select-sm" style="max-width:160px">
                  <option value="">Tất cả</option><option value="normal">Bình thường</option><option value="broken">Hỏng</option><option value="maintenance">Bảo trì</option>
                </select>
                <input id="search-assets" class="form-control form-control-sm" placeholder="Tìm tài sản...">
              </div>
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tbl-assets">
                  <thead>
                    <tr>
                      <th data-col="id">ID <i class="fa-solid fa-filter col-filter-icon" data-table="assets" data-col="id"></i></th>
                      <th data-col="name">Tên <i class="fa-solid fa-filter col-filter-icon" data-table="assets" data-col="name"></i></th>
                      <th data-col="category">Loại <i class="fa-solid fa-filter col-filter-icon" data-table="assets" data-col="category"></i></th>
                      <th data-col="room">Phòng <i class="fa-solid fa-filter col-filter-icon" data-table="assets" data-col="room"></i></th>
                      <th data-col="status">Trạng thái <i class="fa-solid fa-filter col-filter-icon" data-table="assets" data-col="status"></i></th>
                      <th>Ảnh</th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="assets-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Inventory -->
            <div class="tab-pane fade" id="tab-inv">
              <div class="mb-2 d-flex gap-2">
                <input id="search-inv" class="form-control form-control-sm" placeholder="Tìm vật tư...">
                <button id="btn-add-inv" class="btn btn-sm btn-outline-success">Thêm vật tư</button>
              </div>
              <div class="table-responsive">
                <table class="table table-hover" id="tbl-inv">
                  <thead>
                    <tr>
                      <th data-col="id">Mã <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="id"></i></th>
                      <th data-col="name">Tên <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="name"></i></th>
                      <th data-col="category">Loại <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="category"></i></th>
                      <th data-col="qty">Số lượng <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="qty"></i></th>
                      <th data-col="unit">Đơn vị <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="unit"></i></th>
                      <th data-col="price">Giá nhập <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="price"></i></th>
                      <th data-col="vendor">Nhà cung cấp <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="vendor"></i></th>
                      <th data-col="importDate">Ngày nhập <i class="fa-solid fa-filter col-filter-icon" data-table="inv" data-col="importDate"></i></th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="inv-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Requests -->
            <div class="tab-pane fade" id="tab-reqs">
              <div class="d-flex mb-2 gap-2">
                <select id="filter-req-status" class="form-select form-select-sm" style="max-width:160px">
                  <option value="">Tất cả</option><option value="open">Mới</option><option value="in_progress">Đang xử lý</option><option value="done">Hoàn tất</option>
                </select>
                <input id="search-req" class="form-control form-control-sm" placeholder="Tìm yêu cầu...">
              </div>
              <div class="table-responsive">
                <table class="table table-hover" id="tbl-reqs">
                  <thead>
                    <tr>
                      <th data-col="id">Mã <i class="fa-solid fa-filter col-filter-icon" data-table="reqs" data-col="id"></i></th>
                      <th data-col="title">Tiêu đề <i class="fa-solid fa-filter col-filter-icon" data-table="reqs" data-col="title"></i></th>
                      <th data-col="room">Phòng <i class="fa-solid fa-filter col-filter-icon" data-table="reqs" data-col="room"></i></th>
                      <th data-col="reporter">Người báo <i class="fa-solid fa-filter col-filter-icon" data-table="reqs" data-col="reporter"></i></th>
                      <th data-col="status">Trạng thái <i class="fa-solid fa-filter col-filter-icon" data-table="reqs" data-col="status"></i></th>
                      <th>Hành động</th>
                    </tr>
                  </thead>
                  <tbody id="reqs-tbody"></tbody>
                </table>
              </div>
            </div>

            <!-- Logs -->
            <div class="tab-pane fade" id="tab-logs">
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead><tr><th>Thời gian</th><th>Người</th><th>Hành động</th><th>Mô tả</th></tr></thead>
                  <tbody id="logs-tbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-lg-5" id="right-col">
        <div class="card-soft">
          <div class="row g-2 mb-3">
            <div class="col-6"><img src="assets/images/img1.jpg" class="img-fluid rounded" alt=""></div>
            <div class="col-6"><img src="assets/images/img2.jpg" class="img-fluid rounded" alt=""></div>
            <div class="col-6"><img src="assets/images/img3.jpg" class="img-fluid rounded" alt=""></div>
            <div class="col-6"><img src="assets/images/img4.jpg" class="img-fluid rounded" alt=""></div>
          </div>
          <canvas id="chartStatus" height="260"></canvas>
        </div>
      </div>
    </div>

    <footer>© <span id="year"></span> THCS Hàn Thuyên — Local</footer>
  </div>

  <!-- Modals -->
  <!-- Room Modal -->
  <div class="modal fade" id="modalRoom" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <form id="form-room" class="p-3">
      <h5>Thêm / Sửa phòng</h5>
      <input name="id" class="form-control mb-2" placeholder="Mã phòng (vd: R101)" required>
      <input name="name" class="form-control mb-2" placeholder="Tên phòng" required>
      <input name="capacity" type="number" class="form-control mb-2" placeholder="Sức chứa">
      <textarea name="notes" class="form-control mb-2" placeholder="Ghi chú"></textarea>
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-secondary btn-cancel" data-target="modalRoom">Hủy</button>
        <button type="submit" class="btn btn-primary btn-save" data-target="modalRoom">Lưu</button>
      </div>
    </form>
  </div></div></div>

  <!-- Asset/Inventory Modal -->
  <div class="modal fade" id="modalAsset" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
    <form id="form-asset" class="p-3">
      <h5>Thêm / Sửa thiết bị hoặc vật tư</h5>
      <div class="row g-2">
        <div class="col-md-4"><input name="id" class="form-control" placeholder="Mã (tự tạo nếu bỏ trống)"></div>
        <div class="col-md-8"><input name="name" class="form-control" placeholder="Tên"></div>
        <div class="col-md-4"><input name="category" class="form-control" placeholder="Loại (ví dụ: Điện tử, Dụng cụ)"></div>
        <div class="col-md-4"><input name="room" class="form-control" placeholder="Gán phòng (để trống → đưa vào kho)"></div>
        <div class="col-md-4"><input name="quantity" type="number" class="form-control" placeholder="Số lượng (vật tư)"></div>
        <div class="col-md-4"><input name="unit" class="form-control" placeholder="Đơn vị (cái, cuộn, bộ...)"></div>
        <div class="col-md-4"><input name="price" type="number" class="form-control" placeholder="Giá nhập (VND)"></div>
        <div class="col-md-4"><input name="vendor" class="form-control" placeholder="Nhà cung cấp"></div>
        <div class="col-md-4"><input name="importDate" type="date" class="form-control"></div>
        <div class="col-md-6"><input name="image" type="file" accept="image/*" class="form-control form-control-sm"></div>
        <div class="col-12"><textarea name="desc" class="form-control" rows="3" placeholder="Mô tả / ghi chú"></textarea></div>
      </div>
      <div class="mt-2 text-end">
        <button type="button" class="btn btn-outline-secondary btn-cancel" data-target="modalAsset">Hủy</button>
        <button type="submit" class="btn btn-primary btn-save" data-target="modalAsset">Lưu</button>
      </div>
    </form>
  </div></div></div>

  <!-- Inventory Export Modal -->
  <div class="modal fade" id="modalExportInv" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <form id="form-export-inv" class="p-3">
      <h5>Xuất kho → Gán vào phòng</h5>
      <div class="mb-2"><label class="form-label">Vật tư</label><select id="export-inv-select" class="form-select"></select></div>
      <div class="mb-2"><label class="form-label">Số lượng xuất</label><input id="export-qty" type="number" class="form-control" value="1" min="1"></div>
      <div class="mb-2"><label class="form-label">Gán vào phòng</label><select id="export-room" class="form-select"></select></div>
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-secondary btn-cancel" data-target="modalExportInv">Hủy</button>
        <button type="submit" class="btn btn-primary btn-save" data-target="modalExportInv">Xuất kho</button>
      </div>
    </form>
  </div></div></div>

  <!-- Request Modal -->
  <div class="modal fade" id="modalReq" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content">
    <form id="form-req" class="p-3" enctype="multipart/form-data">
      <h5>Tạo / Sửa yêu cầu bảo trì</h5>
      <input name="id" class="form-control mb-2" placeholder="Mã yêu cầu (vd: REQ-001)" required>
      <input name="title" class="form-control mb-2" placeholder="Tiêu đề" required>
      <input name="room" class="form-control mb-2" placeholder="Phòng">
      <input name="reporter" class="form-control mb-2" placeholder="Người báo">
      <input name="img" type="file" accept="image/*" class="form-control mb-2">
      <textarea name="desc" class="form-control mb-2" placeholder="Mô tả"></textarea>
      <select name="status" class="form-select mb-2"><option value="open">Mới</option><option value="in_progress">Đang xử lý</option><option value="done">Hoàn tất</option></select>
      <div class="d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-outline-secondary btn-cancel" data-target="modalReq">Hủy</button>
        <button type="submit" class="btn btn-primary btn-save" data-target="modalReq">Lưu</button>
      </div>
    </form>
  </div></div></div>

  <!-- Users Management Modal -->
  <div class="modal fade" id="modalUsers" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content p-3">
    <h5>Quản lý người dùng (Admin)</h5>
    <div class="mb-2">
      <button id="btn-create-user" class="btn btn-sm btn-success">Tạo người dùng mới</button>
    </div>
    <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Email</th><th>Họ tên</th><th>Vai trò</th><th>Phòng gán (teacher)</th><th>Hành động</th></tr></thead><tbody id="users-tbody"></tbody></table></div>
    <div class="d-flex justify-content-end"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Đóng</button></div>
  </div></div></div>

  <!-- Create User Modal -->
  <div class="modal fade" id="modalCreateUser" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content p-3">
    <h5>Tạo người dùng</h5>
    <input id="cu-email" class="form-control mb-2" placeholder="Email">
    <input id="cu-password" class="form-control mb-2" placeholder="Mật khẩu">
    <input id="cu-name" class="form-control mb-2" placeholder="Tên hiển thị">
    <select id="cu-role" class="form-select mb-2"><option value="teacher">Teacher</option><option value="technician">Technician</option><option value="admin">Admin</option></select>
    <input id="cu-rooms" class="form-control mb-2" placeholder="Phòng gán (comma-separated) - chỉ cho Teacher">
    <div class="d-flex justify-content-end gap-2"><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button><button id="cu-save" class="btn btn-primary">Tạo</button></div>
  </div></div></div>

  <!-- Login Modal -->
  <div class="modal fade" id="modalLogin" tabindex="-1"><div class="modal-dialog modal-sm modal-dialog-centered"><div class="modal-content p-3">
    <h5>Đăng nhập</h5>
    <input id="login-email" class="form-control mb-2" placeholder="Email">
    <input id="login-password" type="password" class="form-control mb-2" placeholder="Mật khẩu">
    <div class="d-flex justify-content-end gap-2"><button id="login-btn" type="button" class="btn btn-primary">Đăng nhập</button><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button></div>
  </div></div></div>

  <!-- Signup Modal -->
  <div class="modal fade" id="modalSignup" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content p-3">
    <h5>Đăng ký</h5>
    <input id="su-email" class="form-control mb-2" placeholder="Email">
    <input id="su-password" type="password" class="form-control mb-2" placeholder="Mật khẩu">
    <input id="su-name" class="form-control mb-2" placeholder="Tên hiển thị">
    <select id="su-role" class="form-select mb-2"><option value="teacher">Teacher</option><option value="technician">Technician</option><option value="admin">Admin</option></select>
    <input id="su-rooms" class="form-control mb-2" placeholder="Phòng gán (vd: R101,R102) - chỉ cho Teacher">
    <div class="d-flex justify-content-end gap-2"><button id="su-btn" type="button" class="btn btn-success">Đăng ký</button><button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button></div>
  </div></div></div>

  <!-- View Modal -->
  <div class="modal fade" id="modalView" tabindex="-1"><div class="modal-dialog modal-md modal-dialog-centered"><div class="modal-content"><div class="modal-body" id="modalViewBody"></div></div></div></div>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Application Scripts -->
  <script src="js/utils.js"></script>
  <script src="js/database.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/export.js"></script>
  <script src="js/app.js"></script>
</body>
</html>